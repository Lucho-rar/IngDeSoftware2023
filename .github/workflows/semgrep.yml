# Name of this GitHub Actions workflow.
name: Semgrep

on:
  # Scan changed files in PRs (diff-aware scanning):
  pull_request: {}
  # Scan on-demand through GitHub Actions interface:
  workflow_dispatch: {}
  # Scan mainline branches and report all findings:
  push:
    branches: ["master", "main"]
  # Schedule the CI job (this method uses cron syntax):
  schedule:
    - cron: '20 17 * * *' # Sets Semgrep to scan every day at 17:20 UTC.
    # It is recommended to change the schedule to a random time.

jobs:
  import-cifr:
    environment: Development
    name: Secrets
    runs-on: ubuntu-latest
    if: (github.actor != 'dependabot[bot]')
    outputs:
      id: imp_sec
      TOKEN_GIT: ${{ steps.imp_sec.outputs.TOKEN_GIT }}
      SONAR_TOK: ${{ steps.imp_sec.outputs.SONAR_TOK }}
      SONAR_HOST: ${{ steps.imp_sec.outputs.SONAR_HOST }}
      SEMGREP_APP_TOK: ${{ steps.imp_sec.outputs.SEMGREP_APP_TOK }}
    steps:
      - name: importar_secretos
        id: imp_sec
        uses: hashicorp/vault-action@v2
        with:
          url: https://sample-cluster-public-vault-0266fbaf.0bff476f.z1.hashicorp.cloud:8200/
          token: ${{secrets.VAULT_TOKEN}}
          tlsSkipVerify: true 
          secrets: |
            admin/secret/data/development TOKEN_GITHUB | ${{ secrets.TOKEN_GIT }};
            admin/secret/data/development SONAR_TOKEN | ${{ secrets.SONAR_TOK }};
            admin/secret/data/development SONAR_HOST_URL | ${{ secrets.SONAR_HOST }};
            admin/secret/data/development SEMGREP_APP_TOKEN | SEMGREP_APP_TOKEN;
      - name: clavar secrets
        id: clav
        run: |
              echo "SEMGREP_APP_TOKEN=$SEMGREP_APP_TOKEN" >> $GITHUB_ENV     
              
  
  otro-job:
    runs-on: ubuntu-latest
    needs: import-cifr
    steps:
      - name: Configurar vault
        run: |
             echo "VAULT_ADDR=https://sample-cluster-public-vault-0266fbaf.0bff476f.z1.hashicorp.cloud:8200" >> $GITHUB_ENV
             echo "VAULT_NAMESPACE=admin" >> $GITHUB_ENV
      - name: Obtener tok
        run: |
            VAULT_TOKEN=$(curl -s --header "X-Vault-Namespace: $VAULT_NAMESPACE" \
             --request POST --data '{"role_id": "9592a17f-4399-2243-a219-7d2a97b516a4", "secret_id": "47174514-b5a2-d0b2-ab9b-064e3e8eae60"}' \
            $VAULT_ADDR/v1/auth/approle/login | jq -r '.auth.client_token')
            echo "VAULT_TOKEN=$VAULT_TOKEN" >> $GITHUB_ENV
      - name: tercer paso
        run: |
              RESPONSE=$(curl -s --header "X-Vault-Token: $VAULT_TOKEN" \
              --header "X-Vault-Namespace: $VAULT_NAMESPACE" \
              $VAULT_ADDR/v1/secret/data/data)

              echo "Respuesta de Vault: $RESPONSE"
            
              LEF=$(echo $RESPONSE | jq -r ".data.data")
              echo "LEF=$LEF" >> $GITHUB_ENV

      - name: HAGAA
        run: |
              echo "asf"
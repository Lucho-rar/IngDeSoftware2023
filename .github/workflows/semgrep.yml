# Name of this GitHub Actions workflow.
name: Semgrep

on:
  # Scan changed files in PRs (diff-aware scanning):
  pull_request: {}
  # Scan on-demand through GitHub Actions interface:
  workflow_dispatch: {}
  # Scan mainline branches and report all findings:
  push:
    branches: ["master", "main"]
  # Schedule the CI job (this method uses cron syntax):
  schedule:
    - cron: '20 17 * * *' # Sets Semgrep to scan every day at 17:20 UTC.
    # It is recommended to change the schedule to a random time.

jobs:
  import-cifr:
    environment: Development
    name: Secrets
    runs-on: ubuntu-latest
    if: (github.actor != 'dependabot[bot]')
    outputs:
      id: imp_sec
      TOKEN_GIT: ${{ steps.imp_sec.outputs.TOKEN_GIT }}
      SONAR_TOK: ${{ steps.imp_sec.outputs.SONAR_TOK }}
      SONAR_HOST: ${{ steps.imp_sec.outputs.SONAR_HOST }}
      SEMGREP_APP_TOK: ${{ steps.imp_sec.outputs.SEMGREP_APP_TOK }}
    steps:
      - name: importar_secretos
        id: imp_sec
        uses: hashicorp/vault-action@v2
        with:
          url: https://sample-cluster-public-vault-0266fbaf.0bff476f.z1.hashicorp.cloud:8200/
          token: ${{secrets.VAULT_TOKEN}}
          tlsSkipVerify: true 
          secrets: |
            admin/secret/data/development TOKEN_GITHUB | ${{ secrets.TOKEN_GIT }};
            admin/secret/data/development SONAR_TOKEN | ${{ secrets.SONAR_TOK }};
            admin/secret/data/development SONAR_HOST_URL | ${{ secrets.SONAR_HOST }};
            admin/secret/data/development SEMGREP_APP_TOKEN | SEMGREP_APP_TOKEN;
      - name: clavar secrets
        id: clav
        run: |
              echo "SEMGREP_APP_TOKEN=$SEMGREP_APP_TOKEN" >> $GITHUB_ENV     
              
  
  otro-job:
    runs-on: ubuntu-latest
    needs: import-cifr
    steps:
      - name: Obtener secretos del job anterior
        run: |
            echo "too $SEMGREP_APP_TOKEN"
            echo "TOKEN_GIT: ${{ needs.import-cifr.outputs.TOKEN_GIT }}"
            echo "SONAR_TOK: ${{ needs.import-cifr.outputs.SONAR_TOK }}"
            echo "SONAR_HOST: ${{ needs.import-cifr.outputs.SONAR_HOST }}"
            echo "SEMGREP_APP_TOK: ${{ needs.import-cifr.outputs.SEMGREP_APP_TOK }}"


  sempgrep:
    name: semgrep/ci
    runs-on: ubuntu-latest
    needs: import-cifr
    container: returntocorp/semgrep
    steps:
      - uses: actions/checkout@v3
      - run: semgrep ci
        env:
          SEMGREP_APP_TOKEN: ${{ needs.import-cifr.outputs.SEMGREP_APP_TOK  }}
        continue-on-error: true
      - name: ver que onda
        run: cat semgrep-results.json